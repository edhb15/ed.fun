<!DOCTYPE html>
<html>
<head>
    <title>Enhanced Flight Simulator</title>
    <style>
        body { margin: 0; overflow: hidden; }
        .hud {
            position: fixed;
            top: 10px;
            left: 10px;
            color: lime;
            font-family: monospace;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid lime;
        }
        .instruments {
            position: fixed;
            bottom: 10px;
            left: 10px;
            width: 200px;
            height: 200px;
            background: rgba(0,0,0,0.7);
            border-radius: 5px;
            border: 1px solid lime;
            padding: 10px;
        }
        .compass {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #222;
            border: 2px solid #555;
            position: relative;
            margin: 0 auto;
        }
        .compass-arrow {
            position: absolute;
            top: 10px;
            left: 48px;
            width: 4px;
            height: 40px;
            background: linear-gradient(red, white);
        }
        .compass-mark {
            position: absolute;
            font-family: monospace;
            color: white;
            font-size: 10px;
        }
        .artificial-horizon {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(to bottom, #1E90FF 50%, #8B4513 50%);
            border: 2px solid #555;
            position: relative;
            margin: 10px auto;
            overflow: hidden;
        }
        .horizon-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: white;
            top: 50px;
            left: 0;
        }
        .instrument-label {
            color: lime;
            font-family: monospace;
            text-align: center;
            margin-top: 5px;
        }
        .view-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: lime;
            border: 1px solid lime;
            padding: 5px 10px;
            font-family: monospace;
            cursor: pointer;
        }
        .cockpit-frame {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: none;
        }
        .cockpit-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .geoFS-hud {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 30px;
            background: rgba(0,0,0,0.7);
            color: white;
            font-family: 'Arial', sans-serif;
            display: flex;
            align-items: center;
            padding: 0 10px;
            z-index: 10;
        }
        .geoFS-buttons {
            position: fixed;
            top: 40px;
            left: 10px;
            display: flex;
            flex-direction: column;
        }
        .geoFS-button {
            background: rgba(0,0,0,0.7);
            color: white;
            border: 1px solid #444;
            padding: 5px 10px;
            margin-bottom: 5px;
            font-family: 'Arial', sans-serif;
            cursor: pointer;
            width: 120px;
            text-align: center;
        }
        .airspeed-indicator {
            position: fixed;
            left: 10px;
            bottom: 220px;
            width: 100px;
            height: 100px;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            border: 2px solid #444;
        }
        .airspeed-needle {
            position: absolute;
            width: 2px;
            height: 45px;
            background: white;
            left: 49px;
            top: 10px;
            transform-origin: bottom center;
        }
        .altitude-indicator {
            position: fixed;
            left: 120px;
            bottom: 220px;
            width: 100px;
            height: 100px;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            border: 2px solid #444;
        }
        .altitude-needle {
            position: absolute;
            width: 2px;
            height: 45px;
            background: white;
            left: 49px;
            top: 10px;
            transform-origin: bottom center;
        }
        .instrument-label {
            color: white;
            font-family: 'Arial', sans-serif;
            font-size: 12px;
            text-align: center;
            margin-top: 5px;
        }
    </style>
    <!-- Add Three.js and required loaders -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/MTLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <!-- Add post-processing dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/SSAOPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
</head>
<body>
    <div id="loading-screen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:linear-gradient(to bottom, #1e5799, #7db9e8); z-index:1000; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <div style="font-size:36px; color:white; font-family:'Arial', sans-serif; font-weight:bold; margin-bottom:20px;">
            Flight Simulator
        </div>
        <div style="width:300px; height:20px; background:rgba(255,255,255,0.3); border-radius:10px; overflow:hidden; margin-bottom:40px;">
            <div id="loading-bar" style="width:0%; height:100%; background:white; border-radius:10px; transition:width 0.5s;"></div>
        </div>
        <div id="loading-text" style="font-size:16px; color:white; font-family:'Arial', sans-serif;">Loading world...</div>
    </div>

    <div id="main-menu" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; display:none; justify-content:center; align-items:center;">
        <div style="width:600px; background:white; padding:20px; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,0.5);">
            <div style="font-size:24px; margin-bottom:20px; text-align:center; font-family:'Arial', sans-serif; font-weight:bold;">
                Flight Simulator
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
                <div id="aircraft-select" style="padding:10px; border:1px solid #ddd; cursor:pointer; text-align:center; font-family:'Arial', sans-serif;">
                    Cessna 172
                </div>
                <div id="location-select" style="padding:10px; border:1px solid #ddd; cursor:pointer; text-align:center; font-family:'Arial', sans-serif;">
                    Default Airport
                </div>
            </div>
            <div id="fly-button" style="background:#4CAF50; color:white; padding:10px; text-align:center; cursor:pointer; font-family:'Arial', sans-serif; font-weight:bold;">
                FLY NOW
            </div>
        </div>
    </div>

    <div class="geoFS-hud">
        <div style="flex: 1;">Speed: <span id="speed">0</span> kt | Alt: <span id="altitude">0</span> ft | Hdg: <span id="heading">0</span>Â°</div>
        <div>Flight Simulator</div>
        <div style="flex: 1; text-align: right;">LON: <span id="lon">0.000</span> LAT: <span id="lat">0.000</span></div>
    </div>

    <div class="geoFS-buttons">
        <div class="geoFS-button" id="autopilotBtn">AUTOPILOT</div>
        <div class="geoFS-button" id="viewBtn">EXTERNAL VIEW</div>
        <div class="geoFS-button" id="mapBtn">MAP</div>
        <div class="geoFS-button" id="resetBtn">RESET</div>
    </div>

    <div class="airspeed-indicator">
        <div class="airspeed-needle" id="airspeed-needle"></div>
    </div>
    <div class="instrument-label">AIRSPEED</div>

    <div class="altitude-indicator">
        <div class="altitude-needle" id="altitude-needle"></div>
    </div>
    <div class="instrument-label">ALTITUDE</div>

    <div class="artificial-horizon" style="position: fixed; left: 10px; bottom: 100px; width: 100px; height: 100px;">
        <div class="horizon-line"></div>
    </div>
    <div class="instrument-label">ATTITUDE</div>

    <div class="compass" style="position: fixed; left: 120px; bottom: 100px; width: 100px; height: 100px;">
        <div class="compass-arrow"></div>
        <div class="compass-mark" style="top: 5px; left: 45px;">N</div>
        <div class="compass-mark" style="top: 45px; left: 85px;">E</div>
        <div class="compass-mark" style="top: 85px; left: 45px;">S</div>
        <div class="compass-mark" style="top: 45px; left: 5px;">W</div>
    </div>
    <div class="instrument-label">HEADING</div>

    <div style="position: fixed; top: 40px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; font-family: 'Arial', sans-serif;">
        <div>FLIGHT DATA</div>
        <hr>
        <div>VS: <span id="vertical-speed">0</span> ft/min</div>
        <div>IAS: <span id="indicated-airspeed">0</span> kt</div>
        <div>GS: <span id="ground-speed">0</span> kt</div>
        <div>Pitch: <span id="pitch-value">0</span>Â°</div>
        <div>Roll: <span id="roll-value">0</span>Â°</div>
        <div>Throttle: <span id="thrust-value">0</span>%</div>
        <div>Stall: <span id="stall">No</span></div>
    </div>

    <div id="debug-panel" style="position: fixed; bottom: 10px; left: 230px; background: rgba(0,0,0,0.7); color: white; padding: 10px; font-family: 'Arial', sans-serif; display: none;">
        <div>DEBUG INFO:</div>
        <div>Heading: <span id="debug-heading">0</span>Â°</div>
        <div>Forward X: <span id="debug-forward-x">0</span></div>
        <div>Forward Y: <span id="debug-forward-y">0</span></div>
        <div>Forward Z: <span id="debug-forward-z">0</span></div>
        <div>Velocity X: <span id="debug-vel-x">0</span></div>
        <div>Velocity Y: <span id="debug-vel-y">0</span></div>
        <div>Velocity Z: <span id="debug-vel-z">0</span></div>
    </div>

    <div id="control-info" style="position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; font-family: 'Arial', sans-serif;">
        Controls: Arrow keys, A/D for yaw, 0-9 for thrust<br>
        L: Auto-level | R: Reset position
    </div>

    <button class="view-toggle" id="viewToggle">Switch to Cockpit View</button>
    <div class="cockpit-frame" id="cockpitFrame">
        <img src="https://i.imgur.com/JXe9uyN.jpg" style="width:100%; height:100%; object-fit:cover; opacity:0.7;">
        <div style="position:absolute; top:0; left:0; width:100%; height:100%; background:linear-gradient(rgba(0,0,0,0.5), transparent, rgba(0,0,0,0.3));"></div>
        <div style="position:absolute; bottom:20%; left:25%; width:50%; height:40%; border:2px solid rgba(255,255,255,0.3); border-radius:10px;"></div>
    </div>

    <div id="map-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:900; display:none; justify-content:center; align-items:center;">
        <div style="width:80%; height:80%; background:#333; border-radius:10px; position:relative; overflow:hidden;">
            <div style="padding:10px; background:#222; color:white; font-family:'Arial', sans-serif; display:flex; justify-content:space-between; align-items:center;">
                <div>Flight Map</div>
                <div id="close-map" style="cursor:pointer; padding:5px 10px; background:#555; border-radius:3px;">Close</div>
            </div>
            <div style="width:100%; height:calc(100% - 40px); background:#111; position:relative;">
                <!-- Simple map implementation -->
                <div id="map-grid" style="width:100%; height:100%; background-image:linear-gradient(rgba(30,144,255,0.1) 1px, transparent 1px),linear-gradient(90deg, rgba(30,144,255,0.1) 1px, transparent 1px); background-size:20px 20px;"></div>
                <div id="map-plane" style="position:absolute; top:50%; left:50%; width:10px; height:10px; background:red; border-radius:50%; transform:translate(-50%, -50%);"></div>
                <div id="map-airport" style="position:absolute; top:48%; left:48%; width:15px; height:15px; background:blue; transform:translate(-50%, -50%);" title="Default Airport"></div>
            </div>
        </div>
    </div>

    <div id="settings-button" style="position:fixed; top:10px; right:120px; background:rgba(0,0,0,0.7); color:white; padding:5px 10px; font-family:'Arial', sans-serif; cursor:pointer; z-index:100;">
        SETTINGS
    </div>

    <div id="settings-panel" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:900; display:none; justify-content:center; align-items:center;">
        <div style="width:600px; background:#333; border-radius:10px; padding:20px; color:white; font-family:'Arial', sans-serif;">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <div style="font-size:20px; font-weight:bold;">Settings</div>
                <div id="close-settings" style="cursor:pointer; padding:5px 10px; background:#555; border-radius:3px;">Close</div>
            </div>
            
            <div style="margin-bottom:15px;">
                <div style="margin-bottom:5px;">Graphics Quality</div>
                <select id="graphics-quality" style="width:100%; padding:5px; background:#444; color:white; border:1px solid #555;">
                    <option>Low</option>
                    <option selected>Medium</option>
                    <option>High</option>
                    <option>Ultra</option>
                </select>
            </div>
            
            <div style="margin-bottom:15px;">
                <div style="margin-bottom:5px;">Control Sensitivity</div>
                <input type="range" style="width:100%;" min="1" max="10" value="5">
            </div>
            
            <div style="margin-bottom:15px;">
                <div style="margin-bottom:5px;">Time of Day</div>
                <input type="range" id="time-slider" style="width:100%;" min="0" max="23" value="12">
                <div style="text-align:center; margin-top:5px;" id="time-display">12:00</div>
            </div>
            
            <div style="margin-bottom:15px;">
                <div style="margin-bottom:5px;">Weather</div>
                <select id="weather-select" style="width:100%; padding:5px; background:#444; color:white; border:1px solid #555;">
                    <option value="clear">Clear</option>
                    <option value="scattered" selected>Scattered Clouds</option>
                    <option value="overcast">Overcast</option>
                    <option value="stormy">Stormy</option>
                </select>
            </div>
        </div>
    </div>

    <div id="flight-plan-button" style="position:fixed; top:10px; right:200px; background:rgba(0,0,0,0.7); color:white; padding:5px 10px; font-family:'Arial', sans-serif; cursor:pointer; z-index:100;">
        FLIGHT PLAN
    </div>

    <div id="flight-plan-panel" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:900; display:none; justify-content:center; align-items:center;">
        <div style="width:600px; background:#333; border-radius:10px; padding:20px; color:white; font-family:'Arial', sans-serif;">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <div style="font-size:20px; font-weight:bold;">Flight Planning</div>
                <div id="close-flight-plan" style="cursor:pointer; padding:5px 10px; background:#555; border-radius:3px;">Close</div>
            </div>
            
            <div>
                <div style="margin-bottom:15px;">
                    <div style="margin-bottom:5px;">Departure</div>
                    <select id="departure-airport" style="width:100%; padding:5px; background:#444; color:white; border:1px solid #555;">
                        <option selected>Default Airport</option>
                        <option>City International</option>
                        <option>Mountain Regional</option>
                        <option>Coastal Airfield</option>
                    </select>
                </div>
                
                <div style="margin-bottom:15px;">
                    <div style="margin-bottom:5px;">Destination</div>
                    <select id="destination-airport" style="width:100%; padding:5px; background:#444; color:white; border:1px solid #555;">
                        <option>Default Airport</option>
                        <option selected>City International</option>
                        <option>Mountain Regional</option>
                        <option>Coastal Airfield</option>
                    </select>
                </div>
                
                <div style="margin-bottom:15px;">
                    <div style="margin-bottom:5px;">Cruising Altitude</div>
                    <select id="cruise-altitude" style="width:100%; padding:5px; background:#444; color:white; border:1px solid #555;">
                        <option>1,000 ft</option>
                        <option selected>5,000 ft</option>
                        <option>10,000 ft</option>
                        <option>15,000 ft</option>
                    </select>
                </div>
                
                <button id="activate-flight-plan" style="width:100%; padding:10px; background:#4CAF50; color:white; border:none; cursor:pointer; font-family:'Arial', sans-serif;">
                    Activate Flight Plan
                </button>
            </div>
        </div>
    </div>

    <div id="flying-school-button" style="position:fixed; top:10px; right:310px; background:rgba(0,0,0,0.7); color:white; padding:5px 10px; font-family:'Arial', sans-serif; cursor:pointer; z-index:100;">
        FLYING SCHOOL
    </div>

    <div id="flying-school-panel" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:900; display:none; justify-content:center; align-items:center;">
        <div style="width:800px; background:#333; border-radius:10px; padding:20px; color:white; font-family:'Arial', sans-serif;">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <div style="font-size:20px; font-weight:bold;">Flying School</div>
                <div id="close-flying-school" style="cursor:pointer; padding:5px 10px; background:#555; border-radius:3px;">Close</div>
            </div>
            
            <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:10px; margin-bottom:20px;">
                <div class="lesson-card" style="background:#444; padding:15px; border-radius:5px; cursor:pointer;">
                    <div style="font-weight:bold; margin-bottom:5px;">Basic Controls</div>
                    <div style="font-size:12px; opacity:0.8;">Learn how to control your aircraft</div>
                </div>
                <div class="lesson-card" style="background:#444; padding:15px; border-radius:5px; cursor:pointer;">
                    <div style="font-weight:bold; margin-bottom:5px;">Take-Off Procedures</div>
                    <div style="font-size:12px; opacity:0.8;">Master the art of take-off</div>
                </div>
                <div class="lesson-card" style="background:#444; padding:15px; border-radius:5px; cursor:pointer;">
                    <div style="font-weight:bold; margin-bottom:5px;">Landing Techniques</div>
                    <div style="font-size:12px; opacity:0.8;">Perfect your landings every time</div>
                </div>
                <div class="lesson-card" style="background:#444; padding:15px; border-radius:5px; cursor:pointer;">
                    <div style="font-weight:bold; margin-bottom:5px;">Navigation</div>
                    <div style="font-size:12px; opacity:0.8;">Learn to navigate using instruments</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Before initializing Three.js, check if WebGL is available
        function checkWebGLSupport() {
            try {
                const canvas = document.createElement('canvas');
                return !!(window.WebGLRenderingContext && 
                    (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')));
            } catch (e) {
                return false;
            }
        }

        // Declare these variables in global scope
        let scene, camera, renderer, airplane, cockpitCamera;
        let position = new THREE.Vector3(0, 100, 0);
        let velocity = new THREE.Vector3(0, 0, 20);
        let rotation = new THREE.Euler(0, 0, 0);
        let rotationVelocity = new THREE.Vector3(0, 0, 0);
        let controls = {
            thrust: 0,
            pitch: 0,
            roll: 0,
            yaw: 0,
            flaps: 0,
            gear: true,
            spoilers: false,
            brakes: 0
        };
        let weatherSystem, timeSystem, autopilot;
        let useThirdPersonView = true;
        let animationFrameId;
        let clouds, sky, skyMaterial;
        let orbitControls;
        
        // A380 specific physics parameters
        const aircraftPhysics = {
            liftCoefficient: 0.4,
            dragCoefficient: 0.015,
            inducedDragCoefficient: 0.08,
            stallAngle: 12,
            maxThrust: 350000, // A380 has more powerful engines
            wingArea: 845, // A380 wing area in square meters
            mass: 560000, // A380 maximum takeoff weight in kg
            momentOfInertia: new THREE.Vector3(2000000, 4000000, 2000000),
            groundEffect: 0.9,
            flapEffectiveness: 1.8,
            spoilerEffectiveness: 0.9,
            maxSpeed: 945, // A380 max speed in km/h
            cruiseSpeed: 903, // A380 cruise speed in km/h
            maxAltitude: 13100, // A380 service ceiling in meters
            turnRate: 0.5, // Reduced turn rate for large aircraft
            acceleration: 0.3, // Slower acceleration for large aircraft
            deceleration: 0.4 // Better deceleration for large aircraft
        };
        
        // Helper function to safely update DOM elements
        function safelyUpdateElement(id, updateFunction) {
            const element = document.getElementById(id);
            if (element) {
                updateFunction(element);
            }
        }
        
        // Notification system
        function showGeoFSNotification(message, duration = 2000) {
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.top = '50px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.background = 'rgba(0,0,0,0.7)';
            notification.style.color = 'white';
            notification.style.padding = '10px 20px';
            notification.style.borderRadius = '5px';
            notification.style.fontFamily = 'Arial, sans-serif';
            notification.style.zIndex = '1000';
            notification.style.textAlign = 'center';
            notification.innerText = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, duration);
        }
        
        // Animation function
        function animate() {
            animationFrameId = requestAnimationFrame(animate);
            
            try {
                if (!position || !velocity || !rotation || !rotationVelocity) {
                    console.error("Physics objects not initialized");
                    return;
                }

                // Calculate airspeed and angle of attack
                const airspeed = velocity.length();
                const angleOfAttack = Math.atan2(velocity.y, Math.sqrt(velocity.x * velocity.x + velocity.z * velocity.z));
                
                // Calculate lift and drag forces
                const dynamicPressure = 0.5 * 1.225 * airspeed * airspeed * aircraftPhysics.wingArea;
                const liftCoefficient = aircraftPhysics.liftCoefficient * Math.sin(angleOfAttack);
                const dragCoefficient = aircraftPhysics.dragCoefficient + 
                    aircraftPhysics.inducedDragCoefficient * liftCoefficient * liftCoefficient;
                
                // Calculate lift and drag forces
                const lift = dynamicPressure * liftCoefficient;
                const drag = dynamicPressure * dragCoefficient;
                
                // Apply ground effect
                const groundEffect = position.y < 10 ? 
                    aircraftPhysics.groundEffect * (1 - position.y / 10) : 0;
                
                // Calculate total forces
                const thrust = controls.thrust * aircraftPhysics.maxThrust;
                const gravity = new THREE.Vector3(0, -9.81 * aircraftPhysics.mass, 0);
                
                // Apply forces to velocity
                const forward = new THREE.Vector3(0, 0, 1).applyEuler(rotation);
                velocity.add(forward.multiplyScalar(thrust / aircraftPhysics.mass));
                velocity.add(new THREE.Vector3(0, lift / aircraftPhysics.mass, 0));
                velocity.add(gravity.multiplyScalar(1 / aircraftPhysics.mass));
                
                // Apply drag
                velocity.multiplyScalar(1 - drag / (aircraftPhysics.mass * airspeed));
                
                // Update rotation based on controls with realistic response
                const controlResponse = 0.02 * (1 + airspeed * 0.01);
                rotationVelocity.x += controls.pitch * controlResponse;
                rotationVelocity.y += controls.yaw * controlResponse;
                rotationVelocity.z += controls.roll * controlResponse;
                
                // Apply rotational damping
                rotationVelocity.multiplyScalar(0.98);
                
                // Update rotation
                rotation.x += rotationVelocity.x;
                rotation.y += rotationVelocity.y;
                rotation.z += rotationVelocity.z;

                // Update position
                position.add(velocity);
                
                // Ground collision with realistic response
                if (position.y < 5) {
                    position.y = 5;
                    velocity.y = Math.max(0, velocity.y * 0.5); // Bounce effect
                    
                    // Apply ground friction
                    velocity.x *= 0.95;
                    velocity.z *= 0.95;
                }

                // Update airplane position and rotation
                if (airplane) {
                    airplane.position.copy(position);
                    airplane.rotation.copy(rotation);
                }

                // Update camera with smooth following
                if (useThirdPersonView) {
                    const cameraOffset = new THREE.Vector3(-30, 15, -60);
                    cameraOffset.applyEuler(rotation);
                    const targetPosition = position.clone().add(cameraOffset);
                    camera.position.lerp(targetPosition, 0.1);
                    camera.lookAt(position);
                }

                // Update HUD elements with more precise values
                safelyUpdateElement('speed', el => el.textContent = Math.round(airspeed * 1.94384));
                safelyUpdateElement('altitude', el => el.textContent = Math.round(position.y * 3.28084));
                safelyUpdateElement('heading', el => el.textContent = Math.round((rotation.y * 180 / Math.PI + 360) % 360));
                safelyUpdateElement('lon', el => el.textContent = (position.x / 1000).toFixed(3));
                safelyUpdateElement('lat', el => el.textContent = (position.z / 1000).toFixed(3));
                
                // Update additional flight data
                safelyUpdateElement('vertical-speed', el => el.textContent = Math.round(velocity.y * 196.85));
                safelyUpdateElement('indicated-airspeed', el => el.textContent = Math.round(airspeed * 1.94384));
                safelyUpdateElement('ground-speed', el => el.textContent = Math.round(airspeed * 1.94384));
                safelyUpdateElement('pitch-value', el => el.textContent = Math.round(rotation.x * 180 / Math.PI));
                safelyUpdateElement('roll-value', el => el.textContent = Math.round(rotation.z * 180 / Math.PI));
                safelyUpdateElement('thrust-value', el => el.textContent = Math.round(controls.thrust * 100));
                safelyUpdateElement('stall', el => el.textContent = Math.abs(angleOfAttack) > aircraftPhysics.stallAngle ? 'Yes' : 'No');

                // Update weather and time
                weatherSystem.updateWeather();
                timeSystem.updateLighting();
                
                // Update autopilot
                

                // Render the scene
                if (renderer && scene && camera) {
                    renderer.render(scene, camera);
                }

            } catch (error) {
                console.error("Animation error:", error);
            }
        }
        
        // Troubleshoot rendering
        function troubleshootRendering() {
            console.log("Troubleshooting rendering issues...");
            
            if (!renderer || !scene || !camera || !airplane) {
                console.error("Required objects not initialized!");
                showGeoFSNotification("Could not fix rendering - missing objects", 3000);
                return;
            }
            
            // Force renderer to clear
            renderer.setClearColor(0x87CEEB, 1);
            renderer.clear();
            
            // Reset camera position
            camera.position.set(0, 100, 100);
            camera.lookAt(0, 0, 0);
            
            // Reset airplane position
            airplane.position.set(0, 50, 0);
            
            // Try a simple render
            renderer.render(scene, camera);
            
            // Reset animation loop
            cancelAnimationFrame(animationFrameId);
            animate();
            
            showGeoFSNotification("Rendering system reset", 3000);
        }
        
        // Map update function
        function updateMap() {
            if (!position || !rotation) return;
            
            // Update plane position on map
            const mapPlane = document.getElementById('map-plane');
            if (mapPlane) {
                // Convert world coordinates to map coordinates
                // Reduce map scale for larger world
                const mapScale = 0.002;
                const mapCenterX = 50;
                const mapCenterY = 50;
                
                const mapX = mapCenterX + position.x * mapScale;
                const mapY = mapCenterY + position.z * mapScale;
                
                mapPlane.style.left = mapX + '%';
                mapPlane.style.top = mapY + '%';
                
                // Rotate the plane icon to match heading
                const headingDegrees = (rotation.y * 180 / Math.PI + 360) % 360;
                mapPlane.style.transform = `translate(-50%, -50%) rotate(${headingDegrees}deg)`;
            }
        }
        
        // Create terrain with more realistic features
        function createTerrain() {
            const size = 200; // Increased resolution
            const heightMap = [];
            
            // World size - increase for more realistic scale
            const worldSize = 200000;
            
            // Generate height map with realistic terrain features
            for (let i = 0; i <= size; i++) {
                heightMap[i] = [];
                for (let j = 0; j <= size; j++) {
                    // Complex terrain generation with multiple layers
                    let height = 0;
                    
                    // Mountain ranges with realistic erosion
                    const mountain1 = 500 * Math.pow(Math.sin(i/10) * Math.cos(j/10), 2);
                    const mountain2 = 200 * Math.sin(i/20) * Math.cos(j/15);
                    const mountain3 = 100 * Math.sin(i/40) * Math.cos(j/30);
                    
                    // Valleys and canyons
                    const valley = -100 * Math.sin(i/30) * Math.sin(j/30);
                    
                    // Plains with subtle variations
                    const plains = 50 * Math.sin(i/60) * Math.sin(j/60);
                    
                    // Add Perlin-like noise for natural look
                    const noise = (Math.sin(i/5) * Math.cos(j/5) + 
                                 Math.sin(i/10) * Math.cos(j/10) + 
                                 Math.sin(i/20) * Math.cos(j/20)) * 20;
                    
                    // Combine features with realistic weighting
                    height = mountain1 * 0.4 + mountain2 * 0.3 + mountain3 * 0.2 + 
                            valley * 0.3 + plains * 0.2 + noise;
                    
                    // Ensure minimum height for water bodies
                    height = Math.max(height, -100);
                    
                    heightMap[i][j] = height;
                }
            }
            
            // Create geometry from height map
            const geometry = new THREE.PlaneGeometry(worldSize, worldSize, size, size);
            const vertices = geometry.attributes.position.array;
            
            for (let i = 0; i <= size; i++) {
                for (let j = 0; j <= size; j++) {
                    const index = 3 * (i * (size + 1) + j) + 1;
                    vertices[index] = heightMap[i][j];
                }
            }
            
            geometry.computeVertexNormals();
            
            // Create realistic terrain materials
            const groundMaterial = new THREE.MeshPhongMaterial({
                color: 0x3d8c40,
                shininess: 0,
                flatShading: false,
                vertexColors: true
            });
            
            // Add vertex colors based on height
            const colors = [];
            for (let i = 0; i <= size; i++) {
                for (let j = 0; j <= size; j++) {
                    const height = heightMap[i][j];
                    let color;
                    
                    if (height < 0) {
                        // Water
                        color = new THREE.Color(0x0077be);
                    } else if (height < 50) {
                        // Sand/Beach
                        color = new THREE.Color(0xf4d03f);
                    } else if (height < 200) {
                        // Grass
                        color = new THREE.Color(0x3d8c40);
                    } else if (height < 500) {
                        // Forest
                        color = new THREE.Color(0x2e7d32);
                    } else {
                        // Snow
                        color = new THREE.Color(0xffffff);
                    }
                    
                    colors.push(color.r, color.g, color.b);
                }
            }
            
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            
            const waterMaterial = new THREE.MeshPhongMaterial({
                color: 0x0077be,
                transparent: true,
                opacity: 0.8,
                shininess: 30,
                specular: 0x444444
            });
            
            // Main terrain
            const terrain = new THREE.Mesh(geometry, groundMaterial);
            terrain.rotation.x = -Math.PI / 2;
            terrain.castShadow = true;
            terrain.receiveShadow = true;
            
            // Create water plane with waves
            const waterGeometry = new THREE.PlaneGeometry(worldSize, worldSize, 100, 100);
            const water = new THREE.Mesh(waterGeometry, waterMaterial);
            water.rotation.x = -Math.PI / 2;
            water.position.y = -15; // Water level
            
            // Add wave animation
            const waveAnimation = function() {
                const time = Date.now() * 0.001;
                const vertices = waterGeometry.attributes.position.array;
                
                for (let i = 0; i < vertices.length; i += 3) {
                    const x = vertices[i];
                    const z = vertices[i + 2];
                    vertices[i + 1] = Math.sin(x * 0.01 + time) * 0.5 + 
                                    Math.sin(z * 0.01 + time) * 0.5;
                }
                
                waterGeometry.attributes.position.needsUpdate = true;
            };
            
            // Add wave animation to the animation loop
            const originalAnimate = animate;
            animate = function() {
                waveAnimation();
                originalAnimate();
            };
            
            const terrainGroup = new THREE.Group();
            terrainGroup.add(terrain);
            terrainGroup.add(water);
            
            return terrainGroup;
        }

        // Create more detailed airplane model
        function createAirplane() {
            const airplane = new THREE.Group();
            
            // Create detailed airplane parts
            const fuselageGeometry = new THREE.CylinderGeometry(1, 1, 8, 16);
            const wingGeometry = new THREE.BoxGeometry(15, 0.5, 3);
            const tailGeometry = new THREE.BoxGeometry(4, 2, 0.5);
            const verticalStabilizerGeometry = new THREE.BoxGeometry(0.5, 2, 3);
            const engineGeometry = new THREE.CylinderGeometry(0.5, 0.5, 2, 16);
            const propellerGeometry = new THREE.BoxGeometry(0.2, 2, 0.1);
            
            // Create materials with realistic properties
            const metalMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x888888,
                shininess: 30,
                specular: 0x444444
            });
            
            const glassMaterial = new THREE.MeshPhongMaterial({
                color: 0x88ccff,
                transparent: true,
                opacity: 0.3,
                shininess: 100,
                specular: 0xffffff
            });
            
            // Create and position parts
            const fuselage = new THREE.Mesh(fuselageGeometry, metalMaterial);
            fuselage.rotation.z = Math.PI / 2;
            
            const wings = new THREE.Mesh(wingGeometry, metalMaterial);
            wings.position.y = 0.5;
            
            const tail = new THREE.Mesh(tailGeometry, metalMaterial);
            tail.position.set(-3, 1, 0);
            
            const verticalStabilizer = new THREE.Mesh(verticalStabilizerGeometry, metalMaterial);
            verticalStabilizer.position.set(-3, 2, 0);
            
            // Add engines
            const leftEngine = new THREE.Mesh(engineGeometry, metalMaterial);
            leftEngine.position.set(0, 0.5, -4);
            leftEngine.rotation.z = Math.PI / 2;
            
            const rightEngine = new THREE.Mesh(engineGeometry, metalMaterial);
            rightEngine.position.set(0, 0.5, 4);
            rightEngine.rotation.z = Math.PI / 2;
            
            // Add propellers
            const leftPropeller = new THREE.Mesh(propellerGeometry, metalMaterial);
            leftPropeller.position.set(0, 0.5, -5);
            
            const rightPropeller = new THREE.Mesh(propellerGeometry, metalMaterial);
            rightPropeller.position.set(0, 0.5, 5);
            
            // Add cockpit glass
            const cockpitGeometry = new THREE.SphereGeometry(1, 16, 16, 0, Math.PI * 2, 0, Math.PI / 2);
            const cockpit = new THREE.Mesh(cockpitGeometry, glassMaterial);
            cockpit.position.set(2, 0.5, 0);
            cockpit.rotation.x = Math.PI;
            
            // Add all parts to the airplane group
            airplane.add(fuselage);
            airplane.add(wings);
            airplane.add(tail);
            airplane.add(verticalStabilizer);
            airplane.add(leftEngine);
            airplane.add(rightEngine);
            airplane.add(leftPropeller);
            airplane.add(rightPropeller);
            airplane.add(cockpit);
            
            // Add propeller animation
            const propellerAnimation = function() {
                const time = Date.now() * 0.01;
                leftPropeller.rotation.y = time * 10;
                rightPropeller.rotation.y = time * 10;
            };
            
            // Add propeller animation to the animation loop
            const originalAnimate = animate;
            animate = function() {
                propellerAnimation();
                originalAnimate();
            };
            
            return airplane;
        }

        // Load A380 model
        function loadA380Model() {
            return new Promise((resolve, reject) => {
                const loader = new THREE.OBJLoader();
                loader.load(
                    'ImageToStl.com_70-a380.obj',
                    (object) => {
                        // Scale and position the model appropriately
                        object.scale.set(0.1, 0.1, 0.1); // Adjust scale as needed
                        object.rotation.x = -Math.PI / 2; // Rotate to correct orientation
                        
                        // Add materials to the model
                        object.traverse((child) => {
                            if (child.isMesh) {
                                child.material = new THREE.MeshPhongMaterial({
                                    color: 0x888888,
                                    shininess: 30,
                                    specular: 0x444444
                                });
                                child.castShadow = true;
                                child.receiveShadow = true;
                            }
                        });
                        
                        resolve(object);
                    },
                    (xhr) => {
                        console.log((xhr.loaded / xhr.total * 100) + '% loaded');
                    },
                    (error) => {
                        console.error('Error loading A380 model:', error);
                        reject(error);
                    }
                );
            });
        }

        // Enhanced camera controls
        function setupCameraControls() {
            orbitControls = new THREE.OrbitControls(camera, renderer.domElement);
            orbitControls.enableDamping = true;
            orbitControls.dampingFactor = 0.05;
            orbitControls.screenSpacePanning = false;
            orbitControls.minDistance = 10;
            orbitControls.maxDistance = 1000;
            orbitControls.maxPolarAngle = Math.PI / 2;
        }
         // Dummy weather system (replace with your real implementation if you have one)
         weatherSystem = {
                    updateWeather: function() {
                        // You can add real weather logic here later
                    }
                };

                // Dummy time system (replace with your real implementation if you have one)
                timeSystem = {
                    updateLighting: function() {
                        // You can add real time-of-day logic here later
                    }
                };

        // Initialize the flight simulator
        async function initFlightSimulator() {
            console.log("initFlightSimulator called");
            try {
                // Create scene
                scene = new THREE.Scene();
                console.log("Scene created");
                
                // Create camera with realistic field of view
                camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 50000);
                camera.fov = 60;
                camera.updateProjectionMatrix();
                console.log("Camera created");
                
                // Create renderer with advanced features
                renderer = new THREE.WebGLRenderer({ 
                    antialias: true,
                    powerPreference: "high-performance"
                });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                renderer.outputEncoding = THREE.sRGBEncoding;
                renderer.toneMapping = THREE.ACESFilmicToneMapping;
                renderer.toneMappingExposure = 1.0;
                document.body.appendChild(renderer.domElement);
                console.log("Renderer created and added to DOM");

                // Setup camera controls
                setupCameraControls();
                
                // Load A380 model
                try {
                    airplane = await loadA380Model();
                    scene.add(airplane);
                    console.log("A380 model loaded successfully");
                } catch (error) {
                    console.error("Failed to load A380 model, using default model:", error);
                    airplane = createAirplane(); // Fallback to default model
                    scene.add(airplane);
                }

                // Create sky with realistic atmosphere
                sky = new THREE.Mesh(
                    new THREE.SphereGeometry(120000, 32, 32),
                    skyMaterial = new THREE.MeshBasicMaterial({
                        color: 0x87CEEB,
                        side: THREE.BackSide
                    })
                );
                scene.add(sky);
                console.log("Sky created and added to scene");

                // Add terrain with shadows
                const terrain = createTerrain();
                terrain.traverse((object) => {
                    if (object.isMesh) {
                        object.castShadow = true;
                        object.receiveShadow = true;
                    }
                });
                scene.add(terrain);
                console.log("Terrain created and added to scene");

                // Add clouds with realistic movement
                const cloudGeometry = new THREE.SphereGeometry(1000, 32, 32);
                const cloudMaterial = new THREE.MeshPhongMaterial({
                    color: 0xffffff,
                    transparent: true,
                    opacity: 0.8,
                    shininess: 0
                });
                
                clouds = new THREE.Group();
                for (let i = 0; i < 50; i++) {
                    const cloud = new THREE.Mesh(cloudGeometry, cloudMaterial);
                    cloud.position.set(
                        Math.random() * 10000 - 5000,
                        Math.random() * 1000 + 1000,
                        Math.random() * 10000 - 5000
                    );
                    cloud.scale.set(
                        Math.random() * 2 + 1,
                        Math.random() * 0.5 + 0.5,
                        Math.random() * 2 + 1
                    );
                    clouds.add(cloud);
                }
                scene.add(clouds);

               

                // Update animation function to use composer if available
                const originalAnimate = animate;
                animate = function() {
                    if (orbitControls) {
                        orbitControls.update();
                    }
                    
                    // Update A380 model position and rotation
                    if (airplane) {
                        airplane.position.copy(position);
                        airplane.rotation.copy(rotation);
                    }
                    
                    originalAnimate();
                };

                // Start animation
                console.log("Starting animation loop");
                animate();

                console.log("Flight simulator initialized successfully");

                // Enhanced keyboard controls for A380
                window.addEventListener('keydown', function(e) {
                    switch (e.key) {
                        case 'ArrowUp': controls.pitch = -0.5; break; // Reduced pitch rate
                        case 'ArrowDown': controls.pitch = 0.5; break;
                        case 'ArrowLeft': controls.roll = -0.5; break; // Reduced roll rate
                        case 'ArrowRight': controls.roll = 0.5; break;
                        case 'a': case 'A': controls.yaw = -0.3; break; // Reduced yaw rate
                        case 'd': case 'D': controls.yaw = 0.3; break;
                        case '0': controls.thrust = 0.0; break;
                        case '1': controls.thrust = 0.1; break;
                        case '2': controls.thrust = 0.2; break;
                        case '3': controls.thrust = 0.3; break;
                        case '4': controls.thrust = 0.4; break;
                        case '5': controls.thrust = 0.5; break;
                        case '6': controls.thrust = 0.6; break;
                        case '7': controls.thrust = 0.7; break;
                        case '8': controls.thrust = 0.8; break;
                        case '9': controls.thrust = 0.9; break;
                        case 'f': case 'F': controls.flaps = Math.min(controls.flaps + 0.1, 1); break;
                        case 'g': case 'G': controls.gear = !controls.gear; break;
                        case 's': case 'S': controls.spoilers = !controls.spoilers; break;
                        case 'b': case 'B': controls.brakes = Math.min(controls.brakes + 0.1, 1); break;
                    }
                });

                // Add UI button event listeners
                const autopilotBtn = document.getElementById('autopilotBtn');
                if (autopilotBtn) autopilotBtn.onclick = function() {
                    if (autopilot.active) {
                        autopilot.deactivate();
                    } else {
                        autopilot.activate();
                    }
                };
                const viewBtn = document.getElementById('viewBtn');
                if (viewBtn) viewBtn.onclick = function() {
                    useThirdPersonView = !useThirdPersonView;
                    viewBtn.textContent = useThirdPersonView ? 'EXTERNAL VIEW' : 'COCKPIT VIEW';
                    document.getElementById('cockpitFrame').style.display = useThirdPersonView ? 'none' : 'block';
                };
                const mapBtn = document.getElementById('mapBtn');
                if (mapBtn) mapBtn.onclick = function() {
                    const mapOverlay = document.getElementById('map-overlay');
                    mapOverlay.style.display = 'flex';
                    document.getElementById('close-map').onclick = function() {
                        mapOverlay.style.display = 'none';
                    };
                };
                const resetBtn = document.getElementById('resetBtn');
                if (resetBtn) resetBtn.onclick = function() {
                    position.set(0, 100, 0);
                    velocity.set(0, 0, 20);
                    rotation.set(0, 0, 0);
                    rotationVelocity.set(0, 0, 0);
                    showGeoFSNotification('Aircraft reset', 1500);
                };
                const settingsBtn = document.getElementById('settings-button');
                if (settingsBtn) settingsBtn.onclick = function() {
                    document.getElementById('settings-panel').style.display = 'flex';
                    document.getElementById('close-settings').onclick = function() {
                        document.getElementById('settings-panel').style.display = 'none';
                    };
                };
                const flightPlanBtn = document.getElementById('flight-plan-button');
                if (flightPlanBtn) flightPlanBtn.onclick = function() {
                    document.getElementById('flight-plan-panel').style.display = 'flex';
                    document.getElementById('close-flight-plan').onclick = function() {
                        document.getElementById('flight-plan-panel').style.display = 'none';
                    };
                };
                const flyingSchoolBtn = document.getElementById('flying-school-button');
                if (flyingSchoolBtn) flyingSchoolBtn.onclick = function() {
                    document.getElementById('flying-school-panel').style.display = 'flex';
                    document.getElementById('close-flying-school').onclick = function() {
                        document.getElementById('flying-school-panel').style.display = 'none';
                    };
                };
            } catch (error) {
                console.error("Failed to initialize flight simulator:", error);
                throw error;
            }
        }

        // Start everything when the page is loaded
        if (checkWebGLSupport()) {
            window.addEventListener('load', () => {
                const loadingBar = document.getElementById('loading-bar');
                const loadingText = document.getElementById('loading-text');
                const loadingScreen = document.getElementById('loading-screen');
                const mainMenu = document.getElementById('main-menu');
                
                let progress = 0;
                const loadingInterval = setInterval(() => {
                    progress += Math.random() * 5;
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(loadingInterval);
                        
                        loadingText.textContent = "Ready to fly!";
                        setTimeout(() => {
                            loadingScreen.style.opacity = "0";
                            loadingScreen.style.transition = "opacity 1s";
                            
                            setTimeout(() => {
                                loadingScreen.style.display = "none";
                                mainMenu.style.display = "flex";
                                
                                // Setup menu interactions
                                document.getElementById('aircraft-select').addEventListener('click', () => {
                                    const aircraftOptions = [
                                        "Cessna 172", 
                                        "Boeing 737", 
                                        "Fighter Jet", 
                                        "Helicopter"
                                    ];
                                    
                                    const currentAircraft = document.getElementById('aircraft-select').textContent.trim();
                                    const currentIndex = aircraftOptions.indexOf(currentAircraft);
                                    const nextIndex = (currentIndex + 1) % aircraftOptions.length;
                                    
                                    document.getElementById('aircraft-select').textContent = aircraftOptions[nextIndex];
                                    showGeoFSNotification(`Selected aircraft: ${aircraftOptions[nextIndex]}`, 2000);
                                });
                                
                                document.getElementById('location-select').addEventListener('click', () => {
                                    const locationOptions = [
                                        "Default Airport", 
                                        "City International", 
                                        "Mountain Regional", 
                                        "Coastal Airfield"
                                    ];
                                    
                                    const currentLocation = document.getElementById('location-select').textContent.trim();
                                    const currentIndex = locationOptions.indexOf(currentLocation);
                                    const nextIndex = (currentIndex + 1) % locationOptions.length;
                                    
                                    document.getElementById('location-select').textContent = locationOptions[nextIndex];
                                    showGeoFSNotification(`Selected location: ${locationOptions[nextIndex]}`, 2000);
                                });
                                
                                // Setup fly button click handler
                                document.getElementById('fly-button').addEventListener('click', () => {
                                    console.log("Fly button clicked");
                                    const mainMenu = document.getElementById('main-menu');
                                    if (mainMenu) {
                                        mainMenu.style.display = "none";
                                    }
                                    showGeoFSNotification('Loading flight...', 2000);
                                    
                                    // Initialize the flight simulator
                                    try {
                                        console.log("Starting flight simulator initialization...");
                                        initFlightSimulator();
                                        console.log("Flight simulator initialized");
                                        showGeoFSNotification('Ready to fly!', 2000);
                                    } catch (error) {
                                        console.error("Error initializing flight simulator:", error);
                                        showGeoFSNotification('Error initializing flight simulator', 3000);
                                    }
                                });
                            }, 1000);
                        }, 500);
                    }
                    loadingBar.style.width = `${progress}%`;
                    loadingText.textContent = `Loading world... ${Math.floor(progress)}%`;
                }, 100);
            });
        }
    </script>
</body>
</html>